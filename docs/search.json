[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "ESS330 Daily Assignment 22",
    "section": "",
    "text": "Objective:\nUse the Poudre River set to understand new methods for analyzing time series forecasting from the modeltime package.\nOMG THE LIBRARIES ARE BUILDING!\n\nlibrary(modeltime)\n\nWarning: package 'modeltime' was built under R version 4.4.3\n\nlibrary(tidyverse)\n\nWarning: package 'tidyverse' was built under R version 4.4.3\n\n\nWarning: package 'ggplot2' was built under R version 4.4.3\n\n\nWarning: package 'tidyr' was built under R version 4.4.3\n\n\nWarning: package 'readr' was built under R version 4.4.3\n\n\nWarning: package 'purrr' was built under R version 4.4.3\n\n\nWarning: package 'dplyr' was built under R version 4.4.3\n\n\nWarning: package 'lubridate' was built under R version 4.4.3\n\n\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.0.4     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors\n\nlibrary(tidymodels)\n\nWarning: package 'tidymodels' was built under R version 4.4.3\n\n\n── Attaching packages ────────────────────────────────────── tidymodels 1.3.0 ──\n✔ broom        1.0.8     ✔ rsample      1.3.0\n✔ dials        1.4.0     ✔ tune         1.3.0\n✔ infer        1.0.8     ✔ workflows    1.2.0\n✔ modeldata    1.4.0     ✔ workflowsets 1.1.0\n✔ parsnip      1.3.1     ✔ yardstick    1.3.2\n✔ recipes      1.3.0     \n\n\nWarning: package 'broom' was built under R version 4.4.3\n\n\nWarning: package 'dials' was built under R version 4.4.3\n\n\nWarning: package 'infer' was built under R version 4.4.3\n\n\nWarning: package 'parsnip' was built under R version 4.4.3\n\n\nWarning: package 'recipes' was built under R version 4.4.3\n\n\nWarning: package 'rsample' was built under R version 4.4.3\n\n\nWarning: package 'tune' was built under R version 4.4.3\n\n\nWarning: package 'workflows' was built under R version 4.4.3\n\n\nWarning: package 'yardstick' was built under R version 4.4.3\n\n\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n\nlibrary(timeSeries)\n\nWarning: package 'timeSeries' was built under R version 4.4.3\n\n\nLoading required package: timeDate\n\nAttaching package: 'timeSeries'\n\nThe following object is masked from 'package:dplyr':\n\n    lag\n\nThe following objects are masked from 'package:graphics':\n\n    lines, points\n\nlibrary(ggplot2)\nlibrary(tsibble)\n\nWarning: package 'tsibble' was built under R version 4.4.3\n\n\nRegistered S3 method overwritten by 'tsibble':\n  method               from \n  as_tibble.grouped_df dplyr\n\nAttaching package: 'tsibble'\n\nThe following object is masked from 'package:lubridate':\n\n    interval\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, union\n\nlibrary(lubridate)\nlibrary(forecast)\n\nWarning: package 'forecast' was built under R version 4.4.3\n\n\nRegistered S3 method overwritten by 'quantmod':\n  method            from\n  as.zoo.data.frame zoo \n\nAttaching package: 'forecast'\n\nThe following object is masked from 'package:yardstick':\n\n    accuracy\n\nlibrary(feasts)\n\nWarning: package 'feasts' was built under R version 4.4.3\n\n\nLoading required package: fabletools\n\n\nWarning: package 'fabletools' was built under R version 4.4.3\n\n\n\nAttaching package: 'fabletools'\n\nThe following object is masked from 'package:yardstick':\n\n    accuracy\n\nThe following object is masked from 'package:parsnip':\n\n    null_model\n\nThe following objects are masked from 'package:infer':\n\n    generate, hypothesize\n\nlibrary(zoo)\n\nWarning: package 'zoo' was built under R version 4.4.3\n\n\n\nAttaching package: 'zoo'\n\nThe following object is masked from 'package:tsibble':\n\n    index\n\nThe following object is masked from 'package:timeSeries':\n\n    time&lt;-\n\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n\nlibrary(xts)\n\nWarning: package 'xts' was built under R version 4.4.3\n\n\n\n######################### Warning from 'xts' package ##########################\n#                                                                             #\n# The dplyr lag() function breaks how base R's lag() function is supposed to  #\n# work, which breaks lag(my_xts). Calls to lag(my_xts) that you type or       #\n# source() into this session won't work correctly.                            #\n#                                                                             #\n# Use stats::lag() to make sure you're not using dplyr::lag(), or you can add #\n# conflictRules('dplyr', exclude = 'lag') to your .Rprofile to stop           #\n# dplyr from breaking base R's lag() function.                                #\n#                                                                             #\n# Code in packages is not affected. It's protected by R's namespace mechanism #\n# Set `options(xts.warn_dplyr_breaks_lag = FALSE)` to suppress this warning.  #\n#                                                                             #\n###############################################################################\n\nAttaching package: 'xts'\n\nThe following objects are masked from 'package:dplyr':\n\n    first, last\n\nlibrary(fable)\n\nWarning: package 'fable' was built under R version 4.4.3\n\nlibrary(prophet)\n\nWarning: package 'prophet' was built under R version 4.4.3\n\n\nLoading required package: Rcpp\n\nAttaching package: 'Rcpp'\n\nThe following object is masked from 'package:rsample':\n\n    populate\n\nLoading required package: rlang\n\n\nWarning: package 'rlang' was built under R version 4.4.3\n\n\n\nAttaching package: 'rlang'\n\nThe following objects are masked from 'package:purrr':\n\n    %@%, flatten, flatten_chr, flatten_dbl, flatten_int, flatten_lgl,\n    flatten_raw, invoke, splice\n\nlibrary(purrr)\nlibrary(timetk)\n\nWarning: package 'timetk' was built under R version 4.4.3\n\nlibrary(caret)\n\nWarning: package 'caret' was built under R version 4.4.3\n\n\nLoading required package: lattice\n\nAttaching package: 'caret'\n\nThe following objects are masked from 'package:fabletools':\n\n    MAE, RMSE\n\nThe following objects are masked from 'package:yardstick':\n\n    precision, recall, sensitivity, specificity\n\nThe following object is masked from 'package:purrr':\n\n    lift\n\nlibrary(rsample)\n\nRe-reading in data from Assignment 21:\n\nlibrary(dataRetrieval)\n\nWarning: package 'dataRetrieval' was built under R version 4.4.3\n\n# Example: Cache la Poudre River at Mouth (USGS site 06752260)\npoudre_flow &lt;- readNWISdv(siteNumber = \"06752260\",\n                          parameterCd = \"00060\",\n                          startDate = \"2013-01-01\",\n                          endDate = \"2023-12-31\") |&gt;\n  renameNWISColumns() |&gt;\n  mutate(Date = yearmonth(Date)) |&gt;\n  mutate(Date = ym(Date)) |&gt;  \n  group_by(Date) |&gt;\n  summarize(Flow = mean(Flow)) |&gt; \n  ungroup() \n\nGET:https://waterservices.usgs.gov/nwis/dv/?site=06752260&format=waterml%2C1.1&ParameterCd=00060&StatCd=00003&startDT=2013-01-01&endDT=2023-12-31\n\n\n\nCreate a Time Series Split:\n\n\n# Making the Tibble of Poudre Flow - Time Series Split:\npf_tbl &lt;- as_tibble(poudre_flow, index = Date)\n\nsplits &lt;- time_series_split(pf_tbl, assess = \"12 months\", cumulative = TRUE)\n\nUsing date_var: Date\n\ntraining &lt;- training(splits)\ntesting &lt;- testing(splits)\n\n\nSpecifying my Models:\n\n\nmods &lt;- list(\n  arima_reg() |&gt;  set_engine(\"auto_arima\"),\n  \n  arima_boost(min_n = 2, learn_rate = 0.015) |&gt; set_engine(engine = \"auto_arima_xgboost\"),\n  \n  prophet_reg() |&gt; set_engine(\"prophet\"),\n  \n  prophet_boost() |&gt; set_engine(\"prophet_xgboost\"),\n  \n  # Exponential Smoothing State Space model\n  exp_smoothing() |&gt; set_engine(engine = \"ets\"),\n  \n  # Multivariate Adaptive Regression Spline model\n  mars(mode = \"regression\") |&gt; set_engine(\"earth\") \n)\n\n\nFitting the Models\n\n\nlibrary(earth)\n\nWarning: package 'earth' was built under R version 4.4.3\n\n\nLoading required package: Formula\n\n\nLoading required package: plotmo\n\n\nWarning: package 'plotmo' was built under R version 4.4.3\n\n\nLoading required package: plotrix\n\n\n\nAttaching package: 'plotrix'\n\n\nThe following object is masked from 'package:scales':\n\n    rescale\n\nmodels &lt;- map(mods, ~ fit(.x, Flow ~ Date, data = training))\n\nfrequency = 12 observations per 1 year\n\n\nfrequency = 12 observations per 1 year\n\n\nDisabling weekly seasonality. Run prophet with weekly.seasonality=TRUE to override this.\n\n\nDisabling daily seasonality. Run prophet with daily.seasonality=TRUE to override this.\n\n\nDisabling weekly seasonality. Run prophet with weekly.seasonality=TRUE to override this.\n\n\nDisabling daily seasonality. Run prophet with daily.seasonality=TRUE to override this.\n\n\nfrequency = 12 observations per 1 year\n\n\n\nBuilding the Modeltime Table\n\n\n(models_tbl &lt;- as_modeltime_table(models))\n\n# Modeltime Table\n# A tibble: 6 × 3\n  .model_id .model   .model_desc            \n      &lt;int&gt; &lt;list&gt;   &lt;chr&gt;                  \n1         1 &lt;fit[+]&gt; ARIMA(0,0,2)(0,1,2)[12]\n2         2 &lt;fit[+]&gt; ARIMA(0,0,2)(0,1,2)[12]\n3         3 &lt;fit[+]&gt; PROPHET                \n4         4 &lt;fit[+]&gt; PROPHET                \n5         5 &lt;fit[+]&gt; ETS(M,N,M)             \n6         6 &lt;fit[+]&gt; EARTH                  \n\n\n\nCalibrating the Models\n\n\n(calibration_table &lt;- modeltime_calibrate(models_tbl, testing, quiet = FALSE))\n\n# Modeltime Table\n# A tibble: 6 × 5\n  .model_id .model   .model_desc             .type .calibration_data\n      &lt;int&gt; &lt;list&gt;   &lt;chr&gt;                   &lt;chr&gt; &lt;list&gt;           \n1         1 &lt;fit[+]&gt; ARIMA(0,0,2)(0,1,2)[12] Test  &lt;tibble [12 × 4]&gt;\n2         2 &lt;fit[+]&gt; ARIMA(0,0,2)(0,1,2)[12] Test  &lt;tibble [12 × 4]&gt;\n3         3 &lt;fit[+]&gt; PROPHET                 Test  &lt;tibble [12 × 4]&gt;\n4         4 &lt;fit[+]&gt; PROPHET                 Test  &lt;tibble [12 × 4]&gt;\n5         5 &lt;fit[+]&gt; ETS(M,N,M)              Test  &lt;tibble [12 × 4]&gt;\n6         6 &lt;fit[+]&gt; EARTH                   Test  &lt;tibble [12 × 4]&gt;\n\n\n\nAccuracy\n\n\nmodeltime_accuracy(calibration_table) |&gt;\n  arrange(mae)\n\n# A tibble: 6 × 9\n  .model_id .model_desc             .type   mae  mape  mase smape  rmse     rsq\n      &lt;int&gt; &lt;chr&gt;                   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;\n1         1 ARIMA(0,0,2)(0,1,2)[12] Test   105.  86.2 0.380  50.6  246. 0.965  \n2         2 ARIMA(0,0,2)(0,1,2)[12] Test   105.  86.2 0.380  50.6  246. 0.965  \n3         5 ETS(M,N,M)              Test   110.  64.6 0.396  46.7  286. 0.828  \n4         3 PROPHET                 Test   162. 385.  0.584 161.   229. 0.855  \n5         4 PROPHET                 Test   162. 385.  0.584 161.   229. 0.855  \n6         6 EARTH                   Test   205. 132.  0.738  92.4  456. 0.00697\n\n\n\nRe-Reading data into Actual Forecast:\n\n\nglimpse(testing)\n\nRows: 12\nColumns: 2\n$ Date &lt;date&gt; 2023-01-01, 2023-02-01, 2023-03-01, 2023-04-01, 2023-05-01, 2023…\n$ Flow &lt;dbl&gt; 7.291935, 21.900357, 28.806452, 76.760000, 648.500000, 1499.23333…\n\nglimpse(pf_tbl)\n\nRows: 132\nColumns: 2\n$ Date &lt;date&gt; 2013-01-01, 2013-02-01, 2013-03-01, 2013-04-01, 2013-05-01, 2013…\n$ Flow &lt;dbl&gt; 18.125806, 18.046429, 8.208710, 5.940667, 332.579677, 299.989333,…\n\n#Reading in actual data\n\npf_future &lt;- readNWISdv(siteNumber = \"06752260\",\n                         parameterCd = \"00060\",\n                         startDate = \"2024-01-01\",\n                         endDate = \"2025-04-01\") |&gt; \n  renameNWISColumns() |&gt;\n  mutate(Date = floor_date(Date, \"month\"),\n         Flow = as.numeric(Flow)) |&gt; \n  group_by(Date) |&gt; \n  summarise(Flow = mean(Flow)) |&gt; \n  ungroup() \n\nGET:https://waterservices.usgs.gov/nwis/dv/?site=06752260&format=waterml%2C1.1&ParameterCd=00060&StatCd=00003&startDT=2024-01-01&endDT=2025-04-01\n\n\n\nForecasting\n\n\n#Previous data\nforecast &lt;- modeltime_forecast(\n  object = calibration_table,\n  h = \"12 months\",\n  actual_data = pf_tbl\n)\n\nplot_modeltime_forecast(forecast)\n\n\n\n\nmodeltime_forecast(\n  object = calibration_table,\n  h = \"12 months\",\n  actual_data = pf_tbl\n)\n\n# Forecast Results\n  \n\n\nConf Method: conformal_default | Conf Interval: 0.95 | Conf By ID: FALSE\n(GLOBAL CONFIDENCE)\n\n\n# A tibble: 204 × 7\n   .model_id .model_desc .key   .index      .value .conf_lo .conf_hi\n       &lt;int&gt; &lt;chr&gt;       &lt;fct&gt;  &lt;date&gt;       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n 1        NA ACTUAL      actual 2013-01-01   18.1        NA       NA\n 2        NA ACTUAL      actual 2013-02-01   18.0        NA       NA\n 3        NA ACTUAL      actual 2013-03-01    8.21       NA       NA\n 4        NA ACTUAL      actual 2013-04-01    5.94       NA       NA\n 5        NA ACTUAL      actual 2013-05-01  333.         NA       NA\n 6        NA ACTUAL      actual 2013-06-01  300.         NA       NA\n 7        NA ACTUAL      actual 2013-07-01   75.6        NA       NA\n 8        NA ACTUAL      actual 2013-08-01   48.8        NA       NA\n 9        NA ACTUAL      actual 2013-09-01 1085.         NA       NA\n10        NA ACTUAL      actual 2013-10-01  146.         NA       NA\n# ℹ 194 more rows\n\n\n\nVisualizing\n\n\nplot_modeltime_forecast(forecast)\n\n\n\n\n\n\nRefit to Full Dataset & Forecast Forward\n\n\nrefit_tbl &lt;- calibration_table |&gt;\n  modeltime_refit(data = pf_tbl)\n\nfrequency = 12 observations per 1 year\nfrequency = 12 observations per 1 year\n\n\nDisabling weekly seasonality. Run prophet with weekly.seasonality=TRUE to override this.\n\n\nDisabling daily seasonality. Run prophet with daily.seasonality=TRUE to override this.\n\n\nDisabling weekly seasonality. Run prophet with weekly.seasonality=TRUE to override this.\n\n\nDisabling daily seasonality. Run prophet with daily.seasonality=TRUE to override this.\n\n\nfrequency = 12 observations per 1 year\n\nrefit_tbl |&gt;\n  modeltime_forecast(h = \"12 months\", actual_data = pf_tbl) |&gt;\n  plot_modeltime_forecast()\n\n\n\n\n\n\nRERUN THIS THING:\n\n\n# New Data\nfuture_forecast &lt;- refit_tbl |&gt;\n  modeltime_forecast(h = \"12 months\", actual_data = pf_future)\n\nglimpse(future_forecast)\n\nRows: 88\nColumns: 7\n$ .model_id   &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…\n$ .model_desc &lt;chr&gt; \"ACTUAL\", \"ACTUAL\", \"ACTUAL\", \"ACTUAL\", \"ACTUAL\", \"ACTUAL\"…\n$ .key        &lt;fct&gt; actual, actual, actual, actual, actual, actual, actual, ac…\n$ .index      &lt;date&gt; 2024-01-01, 2024-02-01, 2024-03-01, 2024-04-01, 2024-05-0…\n$ .value      &lt;dbl&gt; 11.01097, 24.53172, 49.60645, 104.31067, 194.36452, 383.43…\n$ .conf_lo    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…\n$ .conf_hi    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…\n\nrefit_tbl &lt;- calibration_table |&gt;\n  modeltime_refit(data = pf_tbl)\n\nfrequency = 12 observations per 1 year\nfrequency = 12 observations per 1 year\n\n\nDisabling weekly seasonality. Run prophet with weekly.seasonality=TRUE to override this.\n\n\nDisabling daily seasonality. Run prophet with daily.seasonality=TRUE to override this.\n\n\nDisabling weekly seasonality. Run prophet with weekly.seasonality=TRUE to override this.\n\n\nDisabling daily seasonality. Run prophet with daily.seasonality=TRUE to override this.\n\n\nfrequency = 12 observations per 1 year\n\n\n\nMerging Predicted and Actual:\n\nI was having serious issues with trying to find .model_desc from my forecast, I ended up just providing what I have, in my graph below prophet does exist, but this is the code and data I was trying to provide with the subsequent error, although .model_desc WAS DEFNINITELY IN FUTURE FORECAST AND COMPARE DF! &gt; compare_df &lt;- future_forecast |&gt; + filter(.model_desc %in% c(“UPDATE: ARIMA(0,0,2)(0,1,1)[12]”, “PROPHET”)) |&gt; + select(Date = .index, .model_desc, .value) |&gt; + left_join(pf_future, by = “Date”) |&gt; + rename(Predicted = .value, Observed = Flow) Error: object ‘.model_desc’ not found\n\ncompare_df &lt;- future_forecast |&gt;\n  select(Date = .index, .model_desc, .value) |&gt;\n  left_join(pf_future, by = \"Date\") |&gt;\n  rename(Predicted = .value, Observed = Flow)\n\n\nCalculating R-sq\n\n\nlm_model &lt;- lm(Observed ~ Predicted, data = compare_df)\n\nsummary(lm_model)$r.squared\n\n[1] 0.6932388\n\n\nR-squared value = 0.693…\nThis is a very good R-squared value, indicating that the predicted values are closr to the actual values, however, there is still some uncertainty that we can see with the data that was predicted, since the value isn’t at 1.\n\nPlotting the Predicted and Observed\n\n\nggplot(compare_df, aes(x = Predicted, y = Observed)) +\n  geom_point(aes(color = .model_desc)) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dashed\", color = \"gray40\") + \n  geom_smooth(method = \"lm\", se = FALSE, color = \"black\") + \n  facet_wrap(~ .model_desc) +\n  labs(title = \"Predicted vs Observed Streamflow\",\n       x = \"Predicted Monthly Flow (cfs)\",\n       y = \"Observed Monthly Flow (cfs)\",\n       subtitle = \"ESS330 A-22 | Neva Morgan\") +\n  theme_minimal()\n\n`geom_smooth()` using formula = 'y ~ x'"
  }
]